#@layoutT('接口管理')
#define main()
<div class="container-wrap">
   #@formStart()
      #@queryStart('关键词搜索')
	   <input type="search" name="keyword" autocomplete="off" class="layui-input" placeholder="接口路径"/>
      #@queryEnd()
      
       #@queryStart('控制器')
	   <input type="search" name="controller" autocomplete="off" class="layui-input" placeholder="控制器" />
      #@queryEnd()
      #@queryStart('备注')
	   <input type="search" name="remark" autocomplete="off" class="layui-input" placeholder="备注" />
      #@queryEnd()
      
      #@queryStart('所属项目')
      	<select id="projectId" name="projectId" class="layui-select" lay-filter="projectId" >
			<!-- <option value="">--所属项目--</option> -->
			#for(data:projectList)
			<option value="#(data.id??)" #if(for.index==0)selected="selected"#end>#(data.project_name??)</option>
			#end
		</select>
      #@queryEnd()
      
      #set(showLabel=true)
      #@queryStart('接口标题过滤')
		<input type="checkbox" name="state" value="1" lay-skin="switch" lay-text="是|否" lay-filter="stateFilter">
      #@queryEnd()
      
   #@formEnd()
   
	### 前端按钮权限控制,需要放在#@table()之前
	#set(add=delete=edit=del=false)
	
	#permission('/runapi/save')
		#set(add=true)
	#end
	#permission('/runapi/update')
		#set(edit=true)
	#end
	#permission('/runapi/delete')
		#set(delete=del=true)
	#end
	
   #@table()
</div>
#end
#define button()
   ###<button class="layui-btn layui-btn-sm layui-btn-normal" lay-event="doc">项目文档</a>
#end

#define buttonRow()
	#permission('/runapi/debug')
   	<a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="debug">调试</a>
   	#end
   	<a class="layui-btn layui-btn-xs layui-btn-normal" lay-event="review">预览</a>
#end

#define js()
<!-- 分页表格 -->
<script>	
	layui.form.on('select(projectId)', function(data){
		$('#searchBtn_').click();
	});
	
	layui.form.on('switch(stateFilter)', function(data){
		$('#searchBtn_').click();
	});
	
	
   function docFunc(){
		var projectId=$("select[name=projectId]").val();
		var href="#(path)/runapi/doc";
		if(projectId)
			href+="/"+projectId;
		else{
			layer.msg("请选择所属项目")
			return;
		}
		//window.open(href,"_blank");     
		openDialog('项目文档管理',href,true,null,null,null);            
	}
   
   function debugFunc(obj){
      var data=obj.data;
      var debugUrl="#(path)/runapi/debug/"+data.id;
      openDialog(data.remark+"【调试】",debugUrl,false,null,null, {
         end:function(){
            refreshData();
         }
      })
   }

   function reviewFunc(obj){
	   var data=obj.data;
	   if(data.title){
	      var debugUrl="#(path)/runapi/doc/"+data.project_id+'-'+data.id;
	      openDialog(data.title+"【文档预览】",debugUrl,false,null,null, {
	         end:function(){
	            refreshData();
	         }
	      })	
	   }else{
			layer.msg("没用生成接口文档");
	  }
   }

   
   
   initTable();

   function initTable(){
	   var projectId=$("select[name=projectId]").val();
	   var url="#(path)/runapi/list?projectId="+projectId
	    gridArgs.title='系统接口';
	    gridArgs.dataId='id';
	    gridArgs.deleteUrl='#(path)/runapi/delete';
	    gridArgs.updateUrl='#(path)/runapi/edit/';
	    gridArgs.addUrl='#(path)/runapi/add';
	    gridArgs.gridDivId ='maingrid';
	    gridArgs.width=800;
	    gridArgs.height=500;
	    initGrid({id : 'maingrid'
	        ,elem : '#maingrid'
	        ,toolbar:'#table_toolbar'//开启头部工具栏，并为其绑定左侧模板
	        ,cellMinWidth: 100
	        ,cols : [function(){
	            var arr= [
					 {title: '主键',field : 'id',width : 35,checkbox : true},
					 {title:'序号',type:'numbers',width:35},
					 {title:'接口路径',field:'action_key',sort:true},
					 {title:'控制器',field:'controller',width:500,sort:true},
					 {title:'备注',field:'remark'},
					 {title:'接口标题',field:'title',sort:true},
					 {title:'项目',field:'project_name'},
					 {title:'接口描述',field:'describe',hide:true},
					 {title:'请求方式',field:'request_mode',hide:true},
					 {title:'请求路径',field:'request_url',hide:true},
					 {title:'请求参数',field:'request_param',hide:true},
					 {title:'请求参数说明',field:'request_param_explain',hide:true},
					 {title:'请求成功返回示例',field:'success_demo',hide:true},
					 {title:'请求失败返回示例',field:'failuer_demo',hide:true},
					 {title:'请求成功返回示例参数说明',field:'success_demo_explain',hide:true},
					 {title:'创建时间',field:'create_time',hide:true},
					 {title:'创建人',field:'create_by',hide:true},
					 {title:'修改时间',field:'update_time',hide:true},
					 {title:'修改人',field:'update_by',hide:true},
	
	            	{title:'操作',fixed:'right',width : 250,align : 'left',toolbar : '#bar_maingrid'}
	            ];
			    // 初始化筛选状态
			    var local = layui.data('table-filter-maingrid-runapi'); // 获取对应的本地记录
			    layui.each(arr, function(index, item){
			      if(item.field in local){
			        item.hide = local[item.field];
			      }
			    });
			    return arr;
	      	}()]
	        ,url:url
	        ,searchForm : 'searchForm'
	        ,done: function(){
	            // 记录筛选状态
	            var that = this;
	            that.elem.next().on('mousedown', 'input[lay-filter="LAY_TABLE_TOOL_COLS"]+', function(){
	              var input = $(this).prev()[0];
	              // 此处表名可任意定义
	              layui.data('table-filter-maingrid-runapi', {
	                key: input.name
	                ,value: input.checked
	              })
	            });
	            // 开启查询
	            $("#searchBtn_").removeClass("layui-btn-disabled").prop("disabled",false);
	        }
	    },{doc:docFunc,debug:debugFunc,review:reviewFunc});
   }

</script>
#end


